version: '3.7'

services:
    # redis:
    #     image: redis
    #     ports:
    #       - 6380:6379
    #     volumes:
    #       - /nfs/pyromancer/Personal/Tony/CLOUD/redis/data:/data
    #     networks:
    #         - insite-network

    app:
        image: anthonyrawlinsuom/insite-dss
        ports:
          - 8181:8181
        volumes:
          # - /nfs/pyromancer/Projects/DSS/data/insite/queue:/usr/src/app/queue
          # - /nfs/pyromancer/Projects/DSS/data/insite/executable:/usr/src/app/executable
          - ./data/insite/queue:/usr/src/app/queue
          - ./data/insite/executable:/usr/src/app/executable
          - ./data/insite/database.sqlite:/usr/src/app/database.sqlite
        networks:
            - staging-network
            - insite-network
        deploy:
            placement:
                constraints:
                  - node.role == manager
                  - node.hostname == Charcoal
                  # - node.labels.NFS == attached
            labels:
              - "traefik.enable=true"
              - "traefik.http.routers.insite.rule=Host(`insite.lightning.deepblack.cloud`)"
              - "traefik.http.routers.insite.entrypoints=web-secured"
              - "traefik.http.routers.insite.tls.certresolver=letsencryptresolver"
              - "traefik.http.services.insite.loadbalancer.server.port=8181"
              - "traefik.http.services.insite.loadbalancer.passhostheader=true"
              - "traefik.docker.network=staging-network"

networks:
    insite-network:
        driver: overlay
        attachable: true
    staging-network:
        external: true
